import logging
import re
import sys
from subprocess import Popen, PIPE
from jinja2 import Template

MARSHAL_SEC_UP_PATTERN = "^.*Listening on 0.0.0.0:1389.*$"

NETCAT_UP_PATTERN = "^.*.*$"
SPRING_BOOT_UP_PATTERN = "^.*Listening on 0.0.0.0:1389.*$"
CURL_ATTACKER_UP_PATTERN = ""
HTTP_SERVER_UP_PATTERN = ".*1#1: nginx/.*"
MARSHAL_SEC_CALLED_PATTERN = ""
HTTP_CALLED_PATTERN = ".*GET /Log4jRCE.class HTTP/1.*"
NETCAT_CONNECTION_PATTERN = ""


FORMAT = "%(asctime)s:%(levelname)8s -- %(message)s"
logging.basicConfig(format=FORMAT)
logging.root.setLevel(logging.NOTSET)
logger = logging.getLogger(__file__)


def main():
    if len(sys.argv) != 3:
        logger.error("USAGE: python cli.py java_version log4j_version")
        exit(-1)
    java_version = sys.argv[1]
    log4j_version = sys.argv[2]

    logger.info(f"Generating docker-compose.yaml file for Java version: '{java_version}' and Log4J version: '{log4j_version}'")
    with open("docker-compose.yaml.template", "r") as docker_compose_template_file:
        docker_compose_template = docker_compose_template_file.read()    
    t = Template(docker_compose_template)
    docker_compose = t.render(JAVA_VERSION=java_version, LOG4J_VERSION= log4j_version)
    with open("docker-compose.yaml", "w") as docker_compose_file:
        docker_compose_file.write(docker_compose)
    logger.info("Generated docker-compose.yaml file.")

    logger.info("Starting up the docker environment.")
    docker_compose_up_process = Popen(["docker-compose", "up"], stdout=PIPE, stderr=PIPE)
    while True:
        for line in iter(docker_compose_up_process.stdout.readline,''):
            decoded_line = line.rstrip().decode('utf-8')

            if re.match(MARSHAL_SEC_UP_PATTERN, decoded_line):
                logger.info("Marshalsec is up and running")
            
            if re.match(HTTP_SERVER_UP_PATTERN, decoded_line):
                logger.info("Nginx server is up and running")
            
            if re.match(HTTP_CALLED_PATTERN, decoded_line):
                logger.info("Exploit is being dowloaded from the Nginx server")

            if "Remote Code Execution gained!!!" in decoded_line:
                logger.warning("This version of the application is vulnerable !!!!")
                docker_compose_down_process = Popen(["docker-compose", "down"], stdout=PIPE, stderr=PIPE)
                docker_compose_down_process.communicate()
                exit(1)
            if "has to be an integer." in decoded_line:
                print("This version of the application is not vulnerable")
                docker_compose_down_process = Popen(["docker-compose", "down"], stdout=PIPE, stderr=PIPE)
                docker_compose_down_process.communicate()
                exit(0)

if __name__ == "__main__":
    main()
